---
# tasks file for proxy
- name: install packages
  package: name={{item}} state=installed
  with_items:
       - nginx

- name: selinux open http
  shell: setsebool -P httpd_can_network_connect 1

- name: copy proxy config
  template:
   src: proxy.j2
   dest: /etc/nginx/conf.d/proxy.conf
   backup: yes
  notify:
  - restart nginx

- name: copy nginx.conf
  copy:
   src: nginx.conf
   dest: /etc/nginx/nginx.conf
   force: yes
   mode: 0644
   backup: yes
   validate: nginx -t -c %s
  notify:
  - restart nginx

- name: copy htpasswd
  copy:
   src: .htpasswd
   dest: /etc/nginx/.htpasswd
   force: yes
   mode: 0644
   backup: yes
  notify:
  - restart nginx

- uri:
   url: "http://{{ ansible_eth1.ipv4.address }}/"
   follow_redirects: all
   register: webpage
   timeout: 30
   user: zippy
   debug:
    message: "Proxy is available under http://{{ ansible_eth1.ipv4.address }}/"
